{% extends "base/base.html" %}

{% macro save() %}
	<section id="save-changes">
		<br/>
		<button class="btn btn-outline-light btn-save" onclick="submitBot()">{{context.mode}}</button>
		<p style="margin-bottom: 20px"></p>
	</section>
{% endmacro %}

{% block head %}
	<link rel="stylesheet" href="https://api.fateslist.xyz/static/assets/prod/bot_server.min.css" media="none" onload="if(media!='all')media='all'"/>
	<link rel="stylesheet" href="https://api.fateslist.xyz/static/assets/prod/common-settings-menu.min.css" media="none" onload="if(media!='all')media='all'"/>
{% endblock %}

{% block content %}
	{% if context.mode == "edit" %}
		<img style="border-radius: 50%; width: 120px;" class="lozad" data-src="{{bot.user.avatar}}" id="bot-avatar" alt="{{bot.user.username}}'s avatar">
	{% else %}
		<img style="border-radius: 50%; width: 120px;" class="lozad" data-src="https://api.fateslist.xyz/static/botlisticon.webp" id="bot-avatar" alt="Fates List Logo">
	{% endif %}
	<h4 class="white">{% if context.mode == "add" %}Fates List{% else %}{{bot.user.username}}{% endif %}</h4>
	<h5 class="white" style="opacity: 0.8; margin-bottom: 30px;">{% if context.mode == "add" %}Welcome!{% else %}Bot Settings{% endif %}</h5>
	<div id="parent">
		<div id="switcher" style='margin-bottom: 3px;' class='blackbar'>
			<div class="tab">
				{% if context.mode == "edit" %}
					{{ tab("about", default=True) }}
					{{ tab("actions") }}
					{{ tab("analytics") }}
				{% endif %}
				{{ tab("basic-settings", name="Basics", default=True if context.mode == "add" else False) }}
				{{ tab("webhook", name="Webhooks") }}
				{{ tab("links", name="Links") }}
				{{ tab("extras", name="Extras") }}
			</div>
			{% if context.mode == "edit" %}
			<section id="about-tab" class="tabcontent">
				<h5 class="white">Bot Info</h5>
				<div>
					<p class="white"><u>Bot State</u><br/>{{enums.BotState(bot.state).__doc__}} ({{bot.state}})</p><br/>
					{% if bot.flags %}
						<p class="white"><u>Bot Flags</u><br/>{% for flag in bot.flags %}{{enums.BotFlag(flag).name}} ({{flag}})<br/>{% endfor %}</p><br/>
					{% endif %}
					<p class="white"><u>Owners of this bot</u><br/>{{context.owners_html|safe}}</p><br/>
				</div>
				<h5 class="white">API Token</h5>
				<code class="white" id="api-token">Click 'Show' to see your bots token</code>
				<br/>
				<button id="api-button" class="btn btn-outline-light" onclick="showToken(this)">Show</button>
				<h6 class="white section" id="regen-token-header">Regenerate</h6>
				<p class="white"><em>Accidentally</em> leaked your API token? Just be sure to change the token everywhere you use it and make sure it doesn't happen again!</p>
				<button onclick='regenToken()' class="btn btn-outline-light">Regenerate</button>
			</section>
			<section id="actions-tab" class="tabcontent">
				<h5 class="white">Critical Actions Needed</h5>
				{{ tip("These are actions you <em>must</em> take to continue using all features!") }}
				{% if bot.state in (enums.BotState.denied, enums.BotState.banned) %}
				{% set _ = context.update({"actions": True}) %}
					{% set appeal_type = "denied" if bot.state == enums.BotState.denied else "banned" %}
					<h5 class="white section">Bot Appeal</h5>
					<div class="info-content">
                        			<p class="white">
							Your bot was {{ appeal_type }} and needs to be appealed in order to continue using Fates List. These are subject to approval and potential retesting of your bot. Some criteria that you could include:</br/>
							<ul class="white">
								<li>Did you fix the issues you were asked to fix? </li>
								<li>Do you feel like your bot was {{ appeal_type }} for a wrong reason? </li>
								<li>If so (or even if not), mention your reasoning (<em>convincing</em> argument) here! </li>
							</ul>
						</p>
					</div>
					{{ textInput(
						"Write your appeal here",
						"appeal",
						"I feel like... because... and thats why my bot should not have been " + appeal_type,
						in_form=False,
						textarea=True
					) }}
					<button class="btn btn-outline-light" onclick="submitAppeal()">Appeal</button>
				{% endif %}
				{% if not context.actions %}
					<p class="white">All good! You have no critical actions pending (or pending approval)</p>
				{% endif %}
				<h5 class="white">Other Actions</h5>
				<p class="white">Here are some other actions you can take with your bot on Fates List. Most of these can be automated using the API.</p>
				{{ tip("You should still aim to use the API however for best growth and discoverability. Using the API is <em>mandatory</em> for certification other than some very <em>rare</em> exceptions of high quality and exceeding other requirements for certification") }}
				<h5 class="white section">Server Stats</h5>
				{{ textInput(
					"Server Count",
					"server-count",
					"Server count of your bot",
					in_form=False
				) }}
				<button class="section btn btn-outline-light" onclick='postStats()'>Post</button>
				<h5 class="white section">Transfer Ownership</h5>
				{{ textInput(
					"New Owner",
					"new-owner",
					"New owner of your bot",
					in_form=False
				) }}
				<button class="section btn btn-outline-light" onclick='transferOwnership()'>Transfer</button>
				<h5 class="white section">Delete Bot</h5>
				{{ tip(
					"This <em>cannot</em> be undone and you <em>will</em> lose any perks your bot may have such as certification and any votes your bot may have. Think twice before proceeding as not even staff can revert bot deletions, even if accidental...", 
					alert_class="alert-danger tip-red",
					icon="jam:triangle-danger-f"
				) }}
				<button class="btn btn-danger" onclick="deleteBot()">Delete Bot</button>
			</section>
			<section id="analytics-tab" class="tabcontent">
				<h5 class="white">Bot Analytics (Beta)</h5>
				{{ tip("If you face any issues with this feature, please try testing it on the latest version of Google Chrome. This feature is still in beta and may be buggy. Massive UI/UX improvements are planned (graphs)" ) }}
				<button class="section btn btn-outline-light" onclick="listenAnalytics()">Listen</button>
				<div id="output-analytics" class="white" style="border: 1px solid; min-height: 400px; max-height: 400px; overflow: scroll; text-align: left; padding: 3px; white-space: pre-line;">
					Events will be seen here once you start listening!
				</div>
			</section>
			{% endif %}
			<section id="basic-settings-tab" class="tabcontent">
				{{ tip("This is the only section you need to fill out to add or edit your bot. Also, <a href='/fates/rules'>read our rules</a> before submitting") }}
				<br/>
				{{ selectInput(
					"platform",
					"Platform",
					"What platform is your bot in?",
					(
						{
							"value": "discord",
							"text": "Discord",
							"default": True
						},
					),
					required=True
				) }}
				{% if context.mode == "add" %}
					{{ textInput(
						"Bot ID", 
						"bot_id", 
						"Enter Bot ID here", 
						required=True,
						type="number"
					) }}
					<button onclick="autofillBot()" class="btn btn-outline-light">Autofill</button>
				{% endif %}
				{{ textInput(
					"Client ID (only fill this in for old bots)",
					"client_id",
					"You can get this from Developer Portal. Only needed for old bots with differing bot and client ID",
					type="number"
				) }}
				{{ textInput(
					"Extra Owners (comma seperated)", 
					"extra_owners", 
					"790722073248661525, 563808552288780322"
				) }}
				{{ textInput(
					"Prefix (leave blank for slash command only bot)", 
					"prefix", "$, ! etc.", 
					max=9, 
					required=False
				) }}
				{{ textInput(
					"Library", 
					"library", 
					"discord.py etc.", 
					required=True
				) }}
				{{ textInput(
					"Vanity", 
					"vanity", 
					"mybot, fateslist etc. Prefix with _ to disable", 
					required=True
				) }}
				{{ tip(
					"You can use P:PERM_NUMBER (or just leave this blank) if the Bot ID and Client ID are the same (almost always true except for old bots)"
				) }}
				{{ textInput(
					"Invite URL (Leave blank for automatic)", 
					"invite", 
					"https://discord.com/api/oauth2/..."
				) }}
				{{ textInput(
					"Short Description",
					"description", 
					"Fates List is a great bot that does everything you need it to do!", 
					min=10, 
					max=105, 
					required=True
				) }}
				{{ selectInput(
					"tags",
					"Tags",
					"Select tags for your bot",
					context.tags,
					multiple=True,
					required=True
				) }}
				{{ selectInput(
					"features",
					"Features",
					"Select any features your bot has (optional)",
					context.features,
					multiple=True
				) }}
				
				{{ selectInput(
					"long_description_type", 
					"Long Description Type/Format", 
					"Choose your long description type", 
					(
						{
							"value": enums.LongDescType.html.value, 
							"text": "HTML",
							"default": True
						}, 
						{
							"value": enums.LongDescType.markdown_pymarkdown.value, 
							"text": "Markdown (python-markdown)"
						}, 
						{
							"value": enums.LongDescType.markdown_marked.value, 
							"text": "Markdown (marked)"
						}
					),
					required=True
				) }}
				{{ textInput(
					"Long Description", 
					"long_description", 
					"Write over 300 characters for your long description. Trying to put a placeholder to bypass this limit will get your bot denied or banned if found out!", 
					required=True, 
					textarea=True
				) }}
				{{ selectInput(
					"nsfw",
					"NSFW Bot?",
					"Is your bot primarily NSFW?",
					(
						{
							"value": "true",
							"text": "Yes"
						},
						{
							"value": "false",
							"text": "No",
							"default": True
						},
					),
					required=True
				) }}
				{% if staff.perm > 4 or bot.system_bot %}
					{{ selectInput(
						"system_bot",
						"System Bot (set this to no to claim your bot, only staff can set this to yes)",
						"System Bot Status",
						(
							{
								"value": "true",
								"text": "Yes",
							},
							{
								"value": "false",
								"text": "No",
								"default": True
							},
						),
					) }}
				{% endif %}
			</section>
			<section id="links-tab" class="tabcontent">
				{{ optional() }}
				{{ textInput(
					"Website",
					"website",
					"https://mysite.com"
				) }}
				{{ textInput(
					"Github",
					"github",
					"https://github.com/..."
				) }}
				{{ textInput(
					"Privacy Policy URL",
					"privacy_policy",
					"https://myprivacypolicy.com"
				) }}
				{{ textInput(
					"Support Server",
					"support",
					"https://discord.gg/supportserver"
				) }}
				{{ textInput(
					"Donate URL (Patreon/Paypal.me/Buymeacoffee)",
					"donate",
					"https://patreon.com/..."
				) }}
			</section>
			<section id="webhook-tab" class="tabcontent">
				{{ optional() }}
				{{ tip("Webhooks provide a fast and secure way for your bot to recieve events from Fates List such as voting and much more. More information about this is available on our <a href='https://apidocs.fateslist.xyz'>API Documentation</a>. This option does require you to have a server that can recieve the webhooks and you may need to port forward or open your firewall if your server has one. Note that the IP address for Fates List may change but this is rare and the IP is safe to whitelist.") }}
				{{ selectInput(
					"webhook_type",
					"Webhook Type",
					"Select the webhook type",
					(
						{
							"value": enums.WebhookType.vote.value,
							"text": enums.WebhookType.vote.__doc__,
							"default": True
						},
						{
							"value": enums.WebhookType.discord.value,
							"text": enums.WebhookType.discord.__doc__
						},
						{
							"value": enums.WebhookType.fc.value,
							"text": enums.WebhookType.fc.__doc__
						}
					)
				) }}
				{{ textInput(
					"Webhook URL",
					"webhook",
					"https://vote.mysite.com/fates"
				) }}
				{{ tip("API Token is used as the webhook secret if you do not set a webhook secret below. It is recommended to use that unless you need a specific webhook secret to be used by Fates List or you need extra security that cannot be provided using your bots token.") }}
				{{ textInput(
					"Webhook Secret",
					"webhook_secret",
					"Make sure that this is random and secure!"
				) }}
				<button class="btn btn-outline-light" style="margin-bottom: 10px;" onclick="voteBot()">Test Webhook</button>
				{{ tip("Didn't get anything? Make sure you have <em>saved</em> your bot first before clicking Test Webhook. Also check your firewall and network settings as well") }}
			</section>
			<section id="extras-tab" class="tabcontent">
				{{ optional() }}
				<p class="white info-content">Banners allow you to make your bot page look better and more higher quality. There are two banners you can set: one for your bots card and one for your bots page. The banner URL you post here must give a content type of image/**** when a HEAD or a GET request is sent to them (most image services do this). Banner pages also has a 'Keep Banner Decorations/Artifacts' option for some banners that don't work well without it however this does look a bit ugly and so should be disabled if possible</p>
				{{ selectInput(
					"keep_banner_decor",
					"Keep Banner Decorations/Artifacts",
					"Try to make your banner not need this!",
					(
						{
							"value": "true",
							"text": "Yes",
							"default": True
						},
						{
							"value": "false",
							"text": "No"
						}
					)
				) }}
				{{ textInput(
					"Banner URL for bot card",
					"banner_card",
					"Banner URL here"
				) }}
				{{ textInput(
					"Banner URL for bot page",
					"banner_page",
					"Banner URL here"
				) }}
				{{ tip("Custom CSS is a great way to help improve your bots growth along with banners and vote rewards using Webhooks!") }}
				{{ textInput(
					"Custom CSS",
					"css",
					"See w3schools if you need a tutorial on CSS. See our API Documentation for more informatiom about what CSS Fates List has and allows! Have fun :)",
					textarea=True
				) }}
			</section>
		</div>
	</div>
	{{ save() }}	
	<!-- Javascript here -->
	<script>
		var context = {{context|tojson}}
		context.default_tab_button = "{% if context.mode == 'add' %}basic-settings-button{% else %}about-button{% endif %}"
		context.form_values = {
			text: {{form_values_text|tojson}},
			select_single: {{form_values_select_single|tojson}},
			select_multiple: {{form_values_select_multiple|tojson}}
		}

		if(context.actions) {
			setTimeout(() => {
				modalShow("Urgent", "There are some urgent actions you must take in order to continue using Fates List!")
				document.querySelector("#actions-button").click()
			}, 100)
		}
	</script>
	<script src="https://api.fateslist.xyz/static/assets/prod/bot_add_edit.min.js?v=94"></script>
	{% if context.mode == "edit" %}
		<script src="https://api.fateslist.xyz/static/assets/prod/ws.min.js?v=4"></script>
		<script src="https://api.fateslist.xyz/static/assets/prod/vote.min.js?v=13"></script>
	{% endif %}
	<script src="https://api.fateslist.xyz/static/assets/prod/tabs.min.js?v=6"></script>
	<script src="https://cdn.jsdelivr.net/npm/select-pure@latest/dist/index.js"></script>
{% endblock %}
{% block footer %}

{% endblock %}
