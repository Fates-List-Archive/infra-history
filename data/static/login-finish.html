<!DOCTYPE html>
<html lang="en" data-theme="light">
	<head>
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin></script>
		<!-- Primary Meta Tags -->
		<title>Fates List | Logging you in...</title>
		<meta name="title" content="Fates List | Discord Bot List">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<!-- Add Material font (Roboto) and Material icon as needed -->
		<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca&display=swap" rel="stylesheet" media="none" onload="if(media!='all')media='all'">
		<link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet" media="none" onload="if(media!='all')media='all'">
		<link rel="preconnect" href="https://cdn.jsdelivr.net/" crossorigin>
		<link rel="shortcut icon" href="/static/favicon.ico"/>
		<!-- Material CSS -->
		<link href="https://cdn.jsdelivr.net/gh/djibe/material@4.6.0-rc.2/css/material.min.css" rel="stylesheet" defer />
	</head>
	<body>
		<h3 class="text-center" id="msg">Logging you in...</h3>
	</body>
	<script>
		function makeSmaller() {
			$('#msg').contents().unwrap().wrap("<h5 id='msg' class='text-center' style='color: red'></h5>");
		}
		function loginUser() {
			retry = "<br/><br/><a href='https://fateslist.xyz/fates/login'>Try Again?</a>"
			searchParams = new URLSearchParams(window.location.search)
			code = searchParams.get("code")
			state = searchParams.get("state")
			if(!code || !state) {
				makeSmaller()
				$("#msg").html("Invalid code/state" + retry)
				return
			}
			$.ajax({
				url: "/api/users",
				method: "POST",
				contentType: "application/json",
				data: JSON.stringify({"code": code, "state": state}),
				statusCode: {
					206: function(data) {
						window.location.href = localStorage.getItem("login-redirect")
					},
					400: function(data) {
						makeSmaller()
						$("#msg").html(data.responseJSON.reason + retry)
					},
					403: function(data) {
						makeSmaller()
						banInfo = `
	      					<br/><br/>
						<p style="text-align: left !important; margin-left: 10em">
						You have been ${data.responseJSON.ban.type} banned.<br/>
						As a result, ${data.responseJSON.ban.desc}
	       					<br/><br/>
						<strong>Please contact a Fates List Staff Member to appeal this ban</strong>
						</p>
						`
						$("#msg").html(data.responseJSON.reason + banInfo)
					},
					422: function(data) {
						makeSmaller()
						$("#msg").html("Invalid request" + retry)
					},
					429: function(data) {
						makeSmaller()
						$("#msg").html(data.responseJSON.reason + retry)
					},
					500: function(data) {
						makeSmaller()
						$("msg").html("Internal Server Error" + retry)
					}
				}
			})
		}
	$(document).ready(
		function() {
			loginUser()
		}
	)

	</script>
</html>
